<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ESPHome Deye Inverter - Install firmware</title>
  <script type="module" src="https://unpkg.com/esp-web-tools@10/dist/web/install-button.js?module"></script>
  <script>
    (function () {
      var s = localStorage.getItem('esphome-deye-theme');
      var dark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
      if (s === 'dark' || (s !== 'light' && dark)) document.documentElement.setAttribute('data-theme', 'dark');
      else document.documentElement.setAttribute('data-theme', 'light');
    })();
  </script>
  <style>
    /* Theme: light (default) */
    :root,
    [data-theme="light"] {
      --bg: #f1f5f9;
      --bg-card: #ffffff;
      --text: #0f172a;
      --text-muted: #475569;
      --accent: #0d9488;
      --accent-hover: #0f766e;
      --accent-subtle: rgba(13, 148, 136, 0.10);
      --border: #cbd5e1;
      --shadow: rgba(15, 23, 42, 0.08);
    }

    /* Theme: dark (system or manual) */
    @media (prefers-color-scheme: dark) {
      :root:not([data-theme="light"]) {
        --bg: #0c1222;
        --bg-card: #1a2640;
        --text: #f1f5f9;
        --text-muted: #a8bdd4;
        --accent: #2dd4bf;
        --accent-hover: #5eead4;
        --accent-subtle: rgba(45, 212, 191, 0.12);
        --border: #3b5178;
        --shadow: rgba(0, 0, 0, 0.4);
      }
    }

    [data-theme="dark"] {
      --bg: #0c1222;
      --bg-card: #1a2640;
      --text: #f1f5f9;
      --text-muted: #a8bdd4;
      --accent: #2dd4bf;
      --accent-hover: #5eead4;
      --accent-subtle: rgba(45, 212, 191, 0.12);
      --border: #3b5178;
      --shadow: rgba(0, 0, 0, 0.4);
    }

    :root {
      --esp-tools-button-color: var(--accent);
      --esp-tools-button-text-color: #fff;
      --esp-tools-button-border-radius: 10px;
    }

    * {
      box-sizing: border-box;
    }

    body {
      font-family: "Inter", ui-sans-serif, system-ui, -apple-system, sans-serif;
      max-width: 900px;
      margin: 0 auto;
      padding: 1.5rem;
      line-height: 1.65;
      color: var(--text);
      background: var(--bg);
      min-height: 100vh;
      transition: background 0.2s ease, color 0.2s ease;
    }

    .theme-bar {
      display: flex;
      align-items: center;
      justify-content: flex-end;
      gap: 0.5rem;
      margin-bottom: 1.5rem;
    }

    .theme-bar span {
      font-size: 0.8125rem;
      color: var(--text-muted);
      margin-right: 0.25rem;
    }

    .theme-btn {
      background: var(--bg-card);
      color: var(--text);
      border: 1px solid var(--border);
      padding: 0.35rem 0.65rem;
      font-size: 0.8125rem;
      border-radius: 6px;
      cursor: pointer;
      transition: background 0.15s, border-color 0.15s;
    }

    .theme-btn:hover {
      background: var(--border);
    }

    .theme-btn.active {
      background: var(--accent);
      color: #fff;
      border-color: var(--accent);
    }

    h1 {
      font-size: 1.625rem;
      font-weight: 700;
      margin-top: 0;
      letter-spacing: -0.02em;
    }

    p {
      margin: 0.75rem 0;
      color: var(--text);
    }

    p.secondary {
      color: var(--text-muted);
    }

    label {
      display: block;
      font-weight: 600;
      margin-top: 1rem;
      font-size: 0.9375rem;
      color: var(--text);
    }

    .label {
      display: block;
      font-weight: 600;
      font-size: 0.9375rem;
      color: var(--text);
    }

    .option-list {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      margin-top: 0.5rem;
    }

    .option-item {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.75rem 1rem;
      border: 2px solid var(--border);
      border-radius: 10px;
      background: var(--bg-card);
      cursor: pointer;
      transition: border-color 0.2s, background 0.2s;
    }

    .option-item:hover {
      border-color: var(--accent);
      background: var(--bg);
    }

    .option-item:has(input:checked) {
      border-color: var(--accent);
      background: color-mix(in srgb, var(--accent) 14%, var(--bg-card));
    }

    @supports not (background: color-mix(in srgb, red, red)) {
      .option-item:has(input:checked) {
        background: var(--border);
      }
    }

    .option-item input {
      width: 1.125rem;
      height: 1.125rem;
      margin: 0;
      accent-color: var(--accent);
      flex-shrink: 0;
    }

    .option-item .option-label {
      font-weight: 500;
      color: var(--text);
    }

    .option-item .option-desc {
      display: block;
      font-size: 0.875rem;
      color: var(--text-muted);
      margin-top: 0.15rem;
    }

    .step {
      margin-top: 1.5rem;
    }

    .steps-row {
      display: flex;
      gap: 1rem;
      align-items: stretch;
    }

    .steps-row>.card {
      flex: 1;
      min-width: 0;
      margin-top: 1rem;
    }

    @media (max-width: 640px) {
      .steps-row {
        flex-direction: column;
      }
    }

    .install-wrap {
      margin-top: 1.5rem;
    }

    a {
      color: var(--accent);
      text-decoration: none;
    }

    a:hover {
      text-decoration: underline;
    }

    .card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 1.25rem 1.5rem;
      margin-top: 1rem;
      box-shadow: 0 2px 6px var(--shadow);
      transition: background 0.2s ease, border-color 0.2s ease, box-shadow 0.2s ease;
    }

    .install-btn {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      background: var(--accent);
      color: #fff;
      border: none;
      padding: 0.75rem 1.5rem;
      font-size: 1rem;
      font-weight: 600;
      border-radius: 10px;
      cursor: pointer;
      transition: background 0.2s, box-shadow 0.2s, transform 0.1s;
      box-shadow: 0 2px 8px rgba(13, 148, 136, 0.3);
      margin-top: 0.5rem;
    }

    .install-btn:hover {
      background: var(--accent-hover);
      box-shadow: 0 4px 12px rgba(13, 148, 136, 0.4);
      transform: translateY(-1px);
    }

    .install-btn:active {
      transform: translateY(0);
    }

    .install-btn svg {
      width: 1.25rem;
      height: 1.25rem;
      fill: currentColor;
    }
  </style>
</head>

<body>
  <div class="theme-bar">
    <button type="button" class="theme-btn" data-theme="system" aria-pressed="false">Auto</button>
    <button type="button" class="theme-btn" data-theme="light" aria-pressed="false">Light</button>
    <button type="button" class="theme-btn" data-theme="dark" aria-pressed="false">Dark</button>
  </div>

  <h1>ESPHome Deye Inverter</h1>
  <p>
    Firmware for monitoring and controlling Deye PV inverters via Modbus RTU, with
    <a href="https://www.home-assistant.io/">Home Assistant</a> integration.
  </p>
  <p>
    <a href="https://github.com/Lewa-Reka/esphome-deye-inverter">GitHub repository</a>
  </p>

  <div class="steps-row">
    <div class="card">
      <span class="label">1. Device</span>
      <div class="option-list" role="radiogroup" aria-label="Device">
        <label class="option-item">
          <input type="radio" name="device" value="Waveshare-ESP32-S3-RS485-CAN" checked>
          <span>
            <span class="option-label">Waveshare ESP32-S3 RS485 CAN</span>
            <span class="option-desc">ESP32-S3 with RS485 and CAN</span>
          </span>
        </label>
      </div>
    </div>
    <div class="card">
      <span class="label">2. Inverter family</span>
      <div class="option-list" role="radiogroup" aria-label="Inverter family">
        <label class="option-item">
          <input type="radio" name="family" value="Deye-SG0xLP3" checked>
          <span>
            <span class="option-label">Deye SG0xLP3</span>
            <span class="option-desc">3-phase, low voltage</span>
          </span>
        </label>
        <label class="option-item">
          <input type="radio" name="family" value="Deye-SG0xHP3">
          <span>
            <span class="option-label">Deye SG0xHP3</span>
            <span class="option-desc">3-phase, high voltage</span>
          </span>
        </label>
        <label class="option-item">
          <input type="radio" name="family" value="Deye-SG0xLP1">
          <span>
            <span class="option-label">Deye SG0xLP1</span>
            <span class="option-desc">1-phase, low voltage</span>
          </span>
        </label>
      </div>
    </div>
  </div>

  <div class="card">
    <span class="label">3. Install firmware</span>
    <p class="secondary">Connect your ESP via USB, then click to install. After flashing, you can configure Wi-Fi
      (Improv).</p>
    <esp-web-install-button id="install-btn">
      <button slot="activate" class="install-btn">
        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
          <path d="M13 5v6h1.17L12 13.17 9.83 11H11V5h2m2-2H9v6H5l7 7 7-7h-4V3zm4 15H5v2h14v-2z" />
        </svg>
        Connect &amp; Install
      </button>
    </esp-web-install-button>
  </div>

  <script>
    (function () {
      const STORAGE_KEY = 'esphome-deye-theme';
      const root = document.documentElement;

      function getSystemDark() {
        return window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
      }

      function applyTheme(choice) {
        if (choice === 'system') {
          root.removeAttribute('data-theme');
          root.setAttribute('data-theme', getSystemDark() ? 'dark' : 'light');
          root.dataset.themeChoice = 'system';
        } else {
          root.setAttribute('data-theme', choice);
          root.dataset.themeChoice = choice;
        }
        document.querySelectorAll('.theme-btn').forEach(function (btn) {
          btn.classList.toggle('active', btn.dataset.theme === (choice === 'system' ? 'system' : choice));
          btn.setAttribute('aria-pressed', btn.classList.contains('active'));
        });
      }

      var saved = localStorage.getItem(STORAGE_KEY) || 'system';
      applyTheme(saved);

      document.querySelectorAll('.theme-btn').forEach(function (btn) {
        btn.addEventListener('click', function () {
          var choice = this.dataset.theme;
          localStorage.setItem(STORAGE_KEY, choice);
          applyTheme(choice);
        });
      });

      if (window.matchMedia) {
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', function () {
          if ((localStorage.getItem(STORAGE_KEY) || 'system') === 'system') {
            applyTheme('system');
          }
        });
      }
    })();

    const base = window.location.origin + window.location.pathname.replace(/\/?index\.html$/, '') + '/firmware';
    const installBtn = document.getElementById('install-btn');

    function getFamily() {
      var r = document.querySelector('input[name="family"]:checked');
      return r ? r.value : 'Deye-SG0xLP3';
    }

    function getBoard() {
      var r = document.querySelector('input[name="device"]:checked');
      return r ? r.value : 'Waveshare-ESP32-S3-RS485-CAN';
    }

    function updateManifest() {
      var board = getBoard();
      var family = getFamily();
      installBtn.manifest = base + '/' + board + '/' + family + '/manifest.json';
    }

    document.querySelectorAll('input[name="family"]').forEach(function (radio) {
      radio.addEventListener('change', updateManifest);
    });
    document.querySelectorAll('input[name="device"]').forEach(function (radio) {
      radio.addEventListener('change', updateManifest);
    });
    updateManifest();
  </script>
</body>

</html>