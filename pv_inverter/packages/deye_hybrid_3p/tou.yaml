# Copyright 2025 Lewa-Reka <lewareka.yt@gmail.com>
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

substitutions:
  func_int_to_time: |-
    uint8_t hours = raw / 100;
    uint8_t minutes = raw - (hours * 100);
    return ESPTime {.minute = minutes, .hour = hours};
  func_time_to_int: "return x.hour * 100 + x.minute;"

datetime:
  - platform: template
    name: "Time of Use 1 Start"
    id: time_of_use_1_start
    type: time
    update_interval: 15s
    lambda: |-
      auto raw = id(time_of_use_1_start_raw).state;
      ${func_int_to_time}
    set_action:
      - number.set:
          id: time_of_use_1_start_raw
          value: !lambda ${func_time_to_int}

  - platform: template
    name: "Time of Use 2 Start"
    id: time_of_use_2_start
    type: time
    update_interval: 15s
    lambda: |-
      auto raw = id(time_of_use_2_start_raw).state;
      ${func_int_to_time}
    set_action:
      - number.set:
          id: time_of_use_2_start_raw
          value: !lambda ${func_time_to_int}

  - platform: template
    name: "Time of Use 3 Start"
    id: time_of_use_3_start
    type: time
    update_interval: 15s
    lambda: |-
      auto raw = id(time_of_use_3_start_raw).state;
      ${func_int_to_time}
    set_action:
      - number.set:
          id: time_of_use_3_start_raw
          value: !lambda ${func_time_to_int}

  - platform: template
    name: "Time of Use 4 Start"
    id: time_of_use_4_start
    type: time
    update_interval: 15s
    lambda: |-
      auto raw = id(time_of_use_4_start_raw).state;
      ${func_int_to_time}
    set_action:
      - number.set:
          id: time_of_use_4_start_raw
          value: !lambda ${func_time_to_int}

  - platform: template
    name: "Time of Use 5 Start"
    id: time_of_use_5_start
    type: time
    update_interval: 15s
    lambda: |-
      auto raw = id(time_of_use_5_start_raw).state;
      ${func_int_to_time}
    set_action:
      - number.set:
          id: time_of_use_5_start_raw
          value: !lambda ${func_time_to_int}

  - platform: template
    name: "Time of Use 6 Start"
    id: time_of_use_6_start
    type: time
    update_interval: 15s
    lambda: |-
      auto raw = id(time_of_use_6_start_raw).state;
      ${func_int_to_time}
    set_action:
      - number.set:
          id: time_of_use_6_start_raw
          value: !lambda ${func_time_to_int}

switch:
  - platform: template
    name: "Time of Use"
    icon: "mdi:toggle-switch"
    optimistic: true
    restore_mode: DISABLED
    lambda: "return ((int)id(time_of_use_enabled_raw).state & 0b00000001) != 0;"
    turn_on_action:
      - number.set:
          id: time_of_use_enabled_raw
          value: !lambda "return (int)id(time_of_use_enabled_raw).state | 0b00000001;"
    turn_off_action:
      - number.set:
          id: time_of_use_enabled_raw
          value: !lambda "return (int)id(time_of_use_enabled_raw).state & ~0b00000001;"

  - platform: template
    name: "Time of Use Monday"
    icon: "mdi:toggle-switch"
    optimistic: true
    restore_mode: DISABLED
    lambda: "return ((int)id(time_of_use_enabled_raw).state & 0b00000010) != 0;"
    turn_on_action:
      - number.set:
          id: time_of_use_enabled_raw
          value: !lambda "return (int)id(time_of_use_enabled_raw).state | 0b00000010;"
    turn_off_action:
      - number.set:
          id: time_of_use_enabled_raw
          value: !lambda "return (int)id(time_of_use_enabled_raw).state & ~0b00000010;"

  - platform: template
    name: "Time of Use Tuesday"
    icon: "mdi:toggle-switch"
    optimistic: true
    restore_mode: DISABLED
    lambda: "return ((int)id(time_of_use_enabled_raw).state & 0b00000100) != 0;"
    turn_on_action:
      - number.set:
          id: time_of_use_enabled_raw
          value: !lambda "return (int)id(time_of_use_enabled_raw).state | 0b00000100;"
    turn_off_action:
      - number.set:
          id: time_of_use_enabled_raw
          value: !lambda "return (int)id(time_of_use_enabled_raw).state & ~0b00000100;"

  - platform: template
    name: "Time of Use Wednesday"
    icon: "mdi:toggle-switch"
    optimistic: true
    restore_mode: DISABLED
    lambda: "return ((int)id(time_of_use_enabled_raw).state & 0b00001000) != 0;"
    turn_on_action:
      - number.set:
          id: time_of_use_enabled_raw
          value: !lambda "return (int)id(time_of_use_enabled_raw).state | 0b00001000;"
    turn_off_action:
      - number.set:
          id: time_of_use_enabled_raw
          value: !lambda "return (int)id(time_of_use_enabled_raw).state & ~0b00001000;"

  - platform: template
    name: "Time of Use Thursday"
    icon: "mdi:toggle-switch"
    optimistic: true
    restore_mode: DISABLED
    lambda: "return ((int)id(time_of_use_enabled_raw).state & 0b00010000) != 0;"
    turn_on_action:
      - number.set:
          id: time_of_use_enabled_raw
          value: !lambda "return (int)id(time_of_use_enabled_raw).state | 0b00010000;"
    turn_off_action:
      - number.set:
          id: time_of_use_enabled_raw
          value: !lambda "return (int)id(time_of_use_enabled_raw).state & ~0b00010000;"

  - platform: template
    name: "Time of Use Friday"
    icon: "mdi:toggle-switch"
    optimistic: true
    restore_mode: DISABLED
    lambda: "return ((int)id(time_of_use_enabled_raw).state & 0b00100000) != 0;"
    turn_on_action:
      - number.set:
          id: time_of_use_enabled_raw
          value: !lambda "return (int)id(time_of_use_enabled_raw).state | 0b00100000;"
    turn_off_action:
      - number.set:
          id: time_of_use_enabled_raw
          value: !lambda "return (int)id(time_of_use_enabled_raw).state & ~0b00100000;"

  - platform: template
    name: "Time of Use Saturday"
    icon: "mdi:toggle-switch"
    optimistic: true
    restore_mode: DISABLED
    lambda: "return ((int)id(time_of_use_enabled_raw).state & 0b01000000) != 0;"
    turn_on_action:
      - number.set:
          id: time_of_use_enabled_raw
          value: !lambda "return (int)id(time_of_use_enabled_raw).state | 0b01000000;"
    turn_off_action:
      - number.set:
          id: time_of_use_enabled_raw
          value: !lambda "return (int)id(time_of_use_enabled_raw).state & ~0b01000000;"

  - platform: template
    name: "Time of Use Sunday"
    icon: "mdi:toggle-switch"
    optimistic: true
    restore_mode: DISABLED
    lambda: "return ((int)id(time_of_use_enabled_raw).state & 0b10000000) != 0;"
    turn_on_action:
      - number.set:
          id: time_of_use_enabled_raw
          value: !lambda "return (int)id(time_of_use_enabled_raw).state | 0b10000000;"
    turn_off_action:
      - number.set:
          id: time_of_use_enabled_raw
          value: !lambda "return (int)id(time_of_use_enabled_raw).state & ~0b10000000;"

  - platform: template
    name: "Time of Use 1 Grid Charge"
    id: switch_time_of_use_1_grid_charge
    icon: "mdi:battery-plus"
    optimistic: true
    restore_mode: DISABLED
    lambda: "return ((int)id(time_of_use_1_raw).state & 0b00000001) != 0;"
    turn_on_action:
      - number.set:
          id: time_of_use_1_raw
          value: !lambda "return (int)id(time_of_use_1_raw).state | 0b00000001;"
    turn_off_action:
      - number.set:
          id: time_of_use_1_raw
          value: !lambda "return (int)id(time_of_use_1_raw).state & ~0b00000001;"

  - platform: template
    name: "Time of Use 1 Gen"
    id: switch_time_of_use_1_gen
    icon: "mdi:battery-plus"
    optimistic: true
    restore_mode: DISABLED
    lambda: "return ((int)id(time_of_use_1_raw).state & 0b00000010) != 0;"
    turn_on_action:
      - number.set:
          id: time_of_use_1_raw
          value: !lambda "return (int)id(time_of_use_1_raw).state | 0b00000010;"
    turn_off_action:
      - number.set:
          id: time_of_use_1_raw
          value: !lambda "return (int)id(time_of_use_1_raw).state & ~0b00000010;"

  - platform: template
    name: "Time of Use 1 Sell"
    id: switch_time_of_use_1_sell
    icon: "mdi:battery-plus"
    optimistic: true
    restore_mode: DISABLED
    disabled_by_default: true
    lambda: "return ((int)id(time_of_use_1_raw).state & 0b00100000) != 0;"
    turn_on_action:
      - number.set:
          id: time_of_use_1_raw
          value: !lambda "return (int)id(time_of_use_1_raw).state | 0b00100000;"
    turn_off_action:
      - number.set:
          id: time_of_use_1_raw
          value: !lambda "return (int)id(time_of_use_1_raw).state & ~0b00100000;"

  - platform: template
    name: "Time of Use 2 Grid Charge"
    id: switch_time_of_use_2_grid_charge
    icon: "mdi:battery-plus"
    optimistic: true
    restore_mode: DISABLED
    lambda: "return ((int)id(time_of_use_2_raw).state & 0b00000001) != 0;"
    turn_on_action:
      - number.set:
          id: time_of_use_2_raw
          value: !lambda "return (int)id(time_of_use_2_raw).state | 0b00000001;"
    turn_off_action:
      - number.set:
          id: time_of_use_2_raw
          value: !lambda "return (int)id(time_of_use_2_raw).state & ~0b00000001;"

  - platform: template
    name: "Time of Use 2 Gen"
    id: switch_time_of_use_2_gen
    icon: "mdi:battery-plus"
    optimistic: true
    restore_mode: DISABLED
    lambda: "return ((int)id(time_of_use_2_raw).state & 0b00000010) != 0;"
    turn_on_action:
      - number.set:
          id: time_of_use_2_raw
          value: !lambda "return (int)id(time_of_use_2_raw).state | 0b00000010;"
    turn_off_action:
      - number.set:
          id: time_of_use_2_raw
          value: !lambda "return (int)id(time_of_use_2_raw).state & ~0b00000010;"

  - platform: template
    name: "Time of Use 2 Sell"
    id: switch_time_of_use_2_sell
    icon: "mdi:battery-plus"
    optimistic: true
    restore_mode: DISABLED
    disabled_by_default: true
    lambda: "return ((int)id(time_of_use_2_raw).state & 0b00100000) != 0;"
    turn_on_action:
      - number.set:
          id: time_of_use_2_raw
          value: !lambda "return (int)id(time_of_use_2_raw).state | 0b00100000;"
    turn_off_action:
      - number.set:
          id: time_of_use_2_raw
          value: !lambda "return (int)id(time_of_use_2_raw).state & ~0b00100000;"

  - platform: template
    name: "Time of Use 3 Grid Charge"
    id: switch_time_of_use_3_grid_charge
    icon: "mdi:battery-plus"
    optimistic: true
    restore_mode: DISABLED
    lambda: "return ((int)id(time_of_use_3_raw).state & 0b00000001) != 0;"
    turn_on_action:
      - number.set:
          id: time_of_use_3_raw
          value: !lambda "return (int)id(time_of_use_3_raw).state | 0b00000001;"
    turn_off_action:
      - number.set:
          id: time_of_use_3_raw
          value: !lambda "return (int)id(time_of_use_3_raw).state & ~0b00000001;"

  - platform: template
    name: "Time of Use 3 Gen"
    id: switch_time_of_use_3_gen
    icon: "mdi:battery-plus"
    optimistic: true
    restore_mode: DISABLED
    lambda: "return ((int)id(time_of_use_3_raw).state & 0b00000010) != 0;"
    turn_on_action:
      - number.set:
          id: time_of_use_3_raw
          value: !lambda "return (int)id(time_of_use_3_raw).state | 0b00000010;"
    turn_off_action:
      - number.set:
          id: time_of_use_3_raw
          value: !lambda "return (int)id(time_of_use_3_raw).state & ~0b00000010;"

  - platform: template
    name: "Time of Use 3 Sell"
    id: switch_time_of_use_3_sell
    icon: "mdi:battery-plus"
    optimistic: true
    restore_mode: DISABLED
    disabled_by_default: true
    lambda: "return ((int)id(time_of_use_3_raw).state & 0b00100000) != 0;"
    turn_on_action:
      - number.set:
          id: time_of_use_3_raw
          value: !lambda "return (int)id(time_of_use_3_raw).state | 0b00100000;"
    turn_off_action:
      - number.set:
          id: time_of_use_3_raw
          value: !lambda "return (int)id(time_of_use_3_raw).state & ~0b00100000;"

  - platform: template
    name: "Time of Use 4 Grid Charge"
    id: switch_time_of_use_4_grid_charge
    icon: "mdi:battery-plus"
    optimistic: true
    restore_mode: DISABLED
    lambda: "return ((int)id(time_of_use_4_raw).state & 0b00000001) != 0;"
    turn_on_action:
      - number.set:
          id: time_of_use_4_raw
          value: !lambda "return (int)id(time_of_use_4_raw).state | 0b00000001;"
    turn_off_action:
      - number.set:
          id: time_of_use_4_raw
          value: !lambda "return (int)id(time_of_use_4_raw).state & ~0b00000001;"

  - platform: template
    name: "Time of Use 4 Gen"
    id: switch_time_of_use_4_gen
    icon: "mdi:battery-plus"
    optimistic: true
    restore_mode: DISABLED
    lambda: "return ((int)id(time_of_use_4_raw).state & 0b00000010) != 0;"
    turn_on_action:
      - number.set:
          id: time_of_use_4_raw
          value: !lambda "return (int)id(time_of_use_4_raw).state | 0b00000010;"
    turn_off_action:
      - number.set:
          id: time_of_use_4_raw
          value: !lambda "return (int)id(time_of_use_4_raw).state & ~0b00000010;"

  - platform: template
    name: "Time of Use 4 Sell"
    id: switch_time_of_use_4_sell
    icon: "mdi:battery-plus"
    optimistic: true
    restore_mode: DISABLED
    disabled_by_default: true
    lambda: "return ((int)id(time_of_use_4_raw).state & 0b00100000) != 0;"
    turn_on_action:
      - number.set:
          id: time_of_use_4_raw
          value: !lambda "return (int)id(time_of_use_4_raw).state | 0b00100000;"
    turn_off_action:
      - number.set:
          id: time_of_use_4_raw
          value: !lambda "return (int)id(time_of_use_4_raw).state & ~0b00100000;"

  - platform: template
    name: "Time of Use 5 Grid Charge"
    id: switch_time_of_use_5_grid_charge
    icon: "mdi:battery-plus"
    optimistic: true
    restore_mode: DISABLED
    lambda: "return ((int)id(time_of_use_5_raw).state & 0b00000001) != 0;"
    turn_on_action:
      - number.set:
          id: time_of_use_5_raw
          value: !lambda "return (int)id(time_of_use_5_raw).state | 0b00000001;"
    turn_off_action:
      - number.set:
          id: time_of_use_5_raw
          value: !lambda "return (int)id(time_of_use_5_raw).state & ~0b00000001;"

  - platform: template
    name: "Time of Use 5 Gen"
    id: switch_time_of_use_5_gen
    icon: "mdi:battery-plus"
    optimistic: true
    restore_mode: DISABLED
    lambda: "return ((int)id(time_of_use_5_raw).state & 0b00000010) != 0;"
    turn_on_action:
      - number.set:
          id: time_of_use_5_raw
          value: !lambda "return (int)id(time_of_use_5_raw).state | 0b00000010;"
    turn_off_action:
      - number.set:
          id: time_of_use_5_raw
          value: !lambda "return (int)id(time_of_use_5_raw).state & ~0b00000010;"

  - platform: template
    name: "Time of Use 5 Sell"
    id: switch_time_of_use_5_sell
    icon: "mdi:battery-plus"
    optimistic: true
    restore_mode: DISABLED
    disabled_by_default: true
    lambda: "return ((int)id(time_of_use_5_raw).state & 0b00100000) != 0;"
    turn_on_action:
      - number.set:
          id: time_of_use_5_raw
          value: !lambda "return (int)id(time_of_use_5_raw).state | 0b00100000;"
    turn_off_action:
      - number.set:
          id: time_of_use_5_raw
          value: !lambda "return (int)id(time_of_use_5_raw).state & ~0b00100000;"

  - platform: template
    name: "Time of Use 6 Grid Charge"
    id: switch_time_of_use_6_grid_charge
    icon: "mdi:battery-plus"
    optimistic: true
    restore_mode: DISABLED
    lambda: "return ((int)id(time_of_use_6_raw).state & 0b00000001) != 0;"
    turn_on_action:
      - number.set:
          id: time_of_use_6_raw
          value: !lambda "return (int)id(time_of_use_6_raw).state | 0b00000001;"
    turn_off_action:
      - number.set:
          id: time_of_use_6_raw
          value: !lambda "return (int)id(time_of_use_6_raw).state & ~0b00000001;"

  - platform: template
    name: "Time of Use 6 Gen"
    id: switch_time_of_use_6_gen
    icon: "mdi:battery-plus"
    optimistic: true
    restore_mode: DISABLED
    lambda: "return ((int)id(time_of_use_6_raw).state & 0b00000010) != 0;"
    turn_on_action:
      - number.set:
          id: time_of_use_6_raw
          value: !lambda "return (int)id(time_of_use_6_raw).state | 0b00000010;"
    turn_off_action:
      - number.set:
          id: time_of_use_6_raw
          value: !lambda "return (int)id(time_of_use_6_raw).state & ~0b00000010;"

  - platform: template
    name: "Time of Use 6 Sell"
    id: switch_time_of_use_6_sell
    icon: "mdi:battery-plus"
    optimistic: true
    restore_mode: DISABLED
    disabled_by_default: true
    lambda: "return ((int)id(time_of_use_6_raw).state & 0b00100000) != 0;"
    turn_on_action:
      - number.set:
          id: time_of_use_6_raw
          value: !lambda "return (int)id(time_of_use_6_raw).state | 0b00100000;"
    turn_off_action:
      - number.set:
          id: time_of_use_6_raw
          value: !lambda "return (int)id(time_of_use_6_raw).state & ~0b00100000;"

  - platform: template
    name: "Time of Use All Grid Charge"
    id: switch_time_of_use_all_grid_charge
    icon: "mdi:battery-plus"
    optimistic: true
    restore_mode: DISABLED
    disabled_by_default: true
    lambda: |-
      return id(switch_time_of_use_1_grid_charge).state;
    turn_on_action:
      - switch.turn_on:
          id: switch_time_of_use_1_grid_charge
      - switch.turn_on:
          id: switch_time_of_use_2_grid_charge
      - switch.turn_on:
          id: switch_time_of_use_3_grid_charge
      - switch.turn_on:
          id: switch_time_of_use_4_grid_charge
      - switch.turn_on:
          id: switch_time_of_use_5_grid_charge
      - switch.turn_on:
          id: switch_time_of_use_6_grid_charge
    turn_off_action:
      - switch.turn_off:
          id: switch_time_of_use_1_grid_charge
      - switch.turn_off:
          id: switch_time_of_use_2_grid_charge
      - switch.turn_off:
          id: switch_time_of_use_3_grid_charge
      - switch.turn_off:
          id: switch_time_of_use_4_grid_charge
      - switch.turn_off:
          id: switch_time_of_use_5_grid_charge
      - switch.turn_off:
          id: switch_time_of_use_6_grid_charge

  - platform: template
    name: "Time of Use All Gen"
    id: switch_time_of_use_all_gen
    icon: "mdi:battery-plus"
    optimistic: true
    restore_mode: DISABLED
    disabled_by_default: true
    lambda: |-
      return id(switch_time_of_use_1_gen).state;
    turn_on_action:
      - switch.turn_on:
          id: switch_time_of_use_1_gen
      - switch.turn_on:
          id: switch_time_of_use_2_gen
      - switch.turn_on:
          id: switch_time_of_use_3_gen
      - switch.turn_on:
          id: switch_time_of_use_4_gen
      - switch.turn_on:
          id: switch_time_of_use_5_gen
      - switch.turn_on:
          id: switch_time_of_use_6_gen
    turn_off_action:
      - switch.turn_off:
          id: switch_time_of_use_1_gen
      - switch.turn_off:
          id: switch_time_of_use_2_gen
      - switch.turn_off:
          id: switch_time_of_use_3_gen
      - switch.turn_off:
          id: switch_time_of_use_4_gen
      - switch.turn_off:
          id: switch_time_of_use_5_gen
      - switch.turn_off:
          id: switch_time_of_use_6_gen

  - platform: template
    name: "Time of Use All Sell"
    id: switch_time_of_use_all_sell
    icon: "mdi:battery-plus"
    optimistic: true
    restore_mode: DISABLED
    disabled_by_default: true
    lambda: |-
      return id(switch_time_of_use_1_sell).state;
    turn_on_action:
      - switch.turn_on:
          id: switch_time_of_use_1_sell
      - switch.turn_on:
          id: switch_time_of_use_2_sell
      - switch.turn_on:
          id: switch_time_of_use_3_sell
      - switch.turn_on:
          id: switch_time_of_use_4_sell
      - switch.turn_on:
          id: switch_time_of_use_5_sell
      - switch.turn_on:
          id: switch_time_of_use_6_sell
    turn_off_action:
      - switch.turn_off:
          id: switch_time_of_use_1_sell
      - switch.turn_off:
          id: switch_time_of_use_2_sell
      - switch.turn_off:
          id: switch_time_of_use_3_sell
      - switch.turn_off:
          id: switch_time_of_use_4_sell
      - switch.turn_off:
          id: switch_time_of_use_5_sell
      - switch.turn_off:
          id: switch_time_of_use_6_sell

number:
  - platform: modbus_controller
    use_write_multiple: true
    modbus_controller_id: ${modbus_controller_id}
    name: "Time of Use Enabled Raw"
    id: time_of_use_enabled_raw
    register_type: holding
    address: 146
    internal: true

  - platform: modbus_controller
    use_write_multiple: true
    name: "Time of Use 1 Start Raw"
    id: time_of_use_1_start_raw
    modbus_controller_id: ${modbus_controller_id}
    register_type: holding
    address: 148
    value_type: U_WORD
    min_value: 0
    max_value: 2359
    internal: true

  - platform: modbus_controller
    use_write_multiple: true
    name: "Time of Use 2 Start Raw"
    id: time_of_use_2_start_raw
    modbus_controller_id: ${modbus_controller_id}
    register_type: holding
    address: 149
    value_type: U_WORD
    min_value: 0
    max_value: 2359
    internal: true

  - platform: modbus_controller
    use_write_multiple: true
    name: "Time of Use 3 Start Raw"
    id: time_of_use_3_start_raw
    modbus_controller_id: ${modbus_controller_id}
    register_type: holding
    address: 150
    value_type: U_WORD
    min_value: 0
    max_value: 2359
    internal: true

  - platform: modbus_controller
    use_write_multiple: true
    name: "Time of Use 4 Start Raw"
    id: time_of_use_4_start_raw
    modbus_controller_id: ${modbus_controller_id}
    register_type: holding
    address: 151
    value_type: U_WORD
    min_value: 0
    max_value: 2359
    internal: true

  - platform: modbus_controller
    use_write_multiple: true
    name: "Time of Use 5 Start Raw"
    id: time_of_use_5_start_raw
    modbus_controller_id: ${modbus_controller_id}
    register_type: holding
    address: 152
    value_type: U_WORD
    min_value: 0
    max_value: 2359
    internal: true

  - platform: modbus_controller
    use_write_multiple: true
    name: "Time of Use 6 Start Raw"
    id: time_of_use_6_start_raw
    modbus_controller_id: ${modbus_controller_id}
    register_type: holding
    address: 153
    value_type: U_WORD
    min_value: 0
    max_value: 2359
    internal: true

  - platform: modbus_controller
    use_write_multiple: true
    modbus_controller_id: ${modbus_controller_id}
    name: "Time of Use 1 Voltage"
    id: time_of_use_1_voltage
    register_type: holding
    address: 160
    unit_of_measurement: "V"
    device_class: voltage
    value_type: U_WORD
    multiply: 100
    min_value: 0
    max_value: 63
    step: 0.01
    icon: "mdi:sun-clock"

  - platform: modbus_controller
    use_write_multiple: true
    modbus_controller_id: ${modbus_controller_id}
    name: "Time of Use 2 Voltage"
    id: time_of_use_2_voltage
    register_type: holding
    address: 161
    unit_of_measurement: "V"
    device_class: voltage
    value_type: U_WORD
    multiply: 100
    min_value: 0
    max_value: 63
    step: 0.01
    icon: "mdi:sun-clock"

  - platform: modbus_controller
    use_write_multiple: true
    modbus_controller_id: ${modbus_controller_id}
    name: "Time of Use 3 Voltage"
    id: time_of_use_3_voltage
    register_type: holding
    address: 162
    unit_of_measurement: "V"
    device_class: voltage
    value_type: U_WORD
    multiply: 100
    min_value: 0
    max_value: 63
    step: 0.01
    icon: "mdi:sun-clock"

  - platform: modbus_controller
    use_write_multiple: true
    modbus_controller_id: ${modbus_controller_id}
    name: "Time of Use 4 Voltage"
    id: time_of_use_4_voltage
    register_type: holding
    address: 163
    unit_of_measurement: "V"
    device_class: voltage
    value_type: U_WORD
    multiply: 100
    min_value: 0
    max_value: 63
    step: 0.01
    icon: "mdi:sun-clock"

  - platform: modbus_controller
    use_write_multiple: true
    modbus_controller_id: ${modbus_controller_id}
    name: "Time of Use 5 Voltage"
    id: time_of_use_5_voltage
    register_type: holding
    address: 164
    unit_of_measurement: "V"
    device_class: voltage
    value_type: U_WORD
    multiply: 100
    min_value: 0
    max_value: 63
    step: 0.01
    icon: "mdi:sun-clock"

  - platform: modbus_controller
    use_write_multiple: true
    modbus_controller_id: ${modbus_controller_id}
    name: "Time of Use 6 Voltage"
    id: time_of_use_6_voltage
    register_type: holding
    address: 165
    unit_of_measurement: "V"
    device_class: voltage
    value_type: U_WORD
    multiply: 100
    min_value: 0
    max_value: 63
    step: 0.01
    icon: "mdi:sun-clock"

  - platform: modbus_controller
    use_write_multiple: true
    modbus_controller_id: ${modbus_controller_id}
    name: "Time of Use 1 Out Power"
    id: time_of_use_1_out_power
    unit_of_measurement: W
    device_class: power
    address: 154
    value_type: U_WORD
    icon: "mdi:power-plug"

  - platform: modbus_controller
    use_write_multiple: true
    modbus_controller_id: ${modbus_controller_id}
    name: "Time of Use 2 Out Power"
    id: time_of_use_2_out_power
    unit_of_measurement: W
    device_class: power
    address: 155
    value_type: U_WORD
    icon: "mdi:power-plug"

  - platform: modbus_controller
    use_write_multiple: true
    modbus_controller_id: ${modbus_controller_id}
    name: "Time of Use 3 Out Power"
    id: time_of_use_3_out_power
    unit_of_measurement: W
    device_class: power
    address: 156
    value_type: U_WORD
    icon: "mdi:power-plug"

  - platform: modbus_controller
    use_write_multiple: true
    modbus_controller_id: ${modbus_controller_id}
    name: "Time of Use 4 Out Power"
    id: time_of_use_4_out_power
    unit_of_measurement: W
    device_class: power
    address: 157
    value_type: U_WORD
    icon: "mdi:power-plug"

  - platform: modbus_controller
    use_write_multiple: true
    modbus_controller_id: ${modbus_controller_id}
    name: "Time of Use 5 Out Power"
    id: time_of_use_5_out_power
    unit_of_measurement: W
    device_class: power
    address: 158
    value_type: U_WORD
    icon: "mdi:power-plug"

  - platform: modbus_controller
    use_write_multiple: true
    modbus_controller_id: ${modbus_controller_id}
    name: "Time of Use 6 Out Power"
    id: time_of_use_6_out_power
    unit_of_measurement: W
    device_class: power
    address: 159
    value_type: U_WORD
    icon: "mdi:power-plug"

  - platform: modbus_controller
    use_write_multiple: true
    modbus_controller_id: ${modbus_controller_id}
    name: "Time of Use 1 SoC"
    id: time_of_use_1_soc
    unit_of_measurement: "%"
    address: 166
    min_value: 0
    max_value: 100
    step: 1
    value_type: U_WORD
    icon: "mdi:battery-clock"

  - platform: modbus_controller
    use_write_multiple: true
    modbus_controller_id: ${modbus_controller_id}
    name: "Time of Use 2 SoC"
    id: time_of_use_2_soc
    unit_of_measurement: "%"
    address: 167
    min_value: 0
    max_value: 100
    step: 1
    value_type: U_WORD
    icon: "mdi:battery-clock"

  - platform: modbus_controller
    use_write_multiple: true
    modbus_controller_id: ${modbus_controller_id}
    name: "Time of Use 3 SoC"
    id: time_of_use_3_soc
    unit_of_measurement: "%"
    address: 168
    min_value: 0
    max_value: 100
    step: 1
    value_type: U_WORD
    icon: "mdi:battery-clock"

  - platform: modbus_controller
    use_write_multiple: true
    modbus_controller_id: ${modbus_controller_id}
    name: "Time of Use 4 SoC"
    id: time_of_use_4_soc
    unit_of_measurement: "%"
    address: 169
    min_value: 0
    max_value: 100
    step: 1
    value_type: U_WORD
    icon: "mdi:battery-clock"

  - platform: modbus_controller
    use_write_multiple: true
    modbus_controller_id: ${modbus_controller_id}
    name: "Time of Use 5 SoC"
    id: time_of_use_5_soc
    unit_of_measurement: "%"
    address: 170
    min_value: 0
    max_value: 100
    step: 1
    value_type: U_WORD
    icon: "mdi:battery-clock"

  - platform: modbus_controller
    use_write_multiple: true
    modbus_controller_id: ${modbus_controller_id}
    name: "Time of Use 6 SoC"
    id: time_of_use_6_soc
    unit_of_measurement: "%"
    address: 171
    min_value: 0
    max_value: 100
    step: 1
    value_type: U_WORD
    icon: "mdi:battery-clock"

  - platform: template
    name: "Time of Use All SoC"
    id: time_of_use_all_soc
    unit_of_measurement: "%"
    device_class: battery
    min_value: 0
    max_value: 100
    step: 1
    update_interval: 1s
    icon: "mdi:battery-clock"
    disabled_by_default: true
    lambda: |-
      return id(time_of_use_1_soc).state;
    set_action:
      - number.set:
          id: time_of_use_1_soc
          value: !lambda "return x;"
      - number.set:
          id: time_of_use_2_soc
          value: !lambda "return x;"
      - number.set:
          id: time_of_use_3_soc
          value: !lambda "return x;"
      - number.set:
          id: time_of_use_4_soc
          value: !lambda "return x;"
      - number.set:
          id: time_of_use_5_soc
          value: !lambda "return x;"
      - number.set:
          id: time_of_use_6_soc
          value: !lambda "return x;"

  - platform: template
    name: "Time of Use All Out Power"
    id: time_of_use_all_out_power
    unit_of_measurement: W
    device_class: power
    min_value: 0
    max_value: 20000
    step: 1
    update_interval: 1s
    icon: "mdi:power-plug"
    disabled_by_default: true
    lambda: |-
      return id(time_of_use_1_out_power).state;
    set_action:
      - number.set:
          id: time_of_use_1_out_power
          value: !lambda "return x;"
      - number.set:
          id: time_of_use_2_out_power
          value: !lambda "return x;"
      - number.set:
          id: time_of_use_3_out_power
          value: !lambda "return x;"
      - number.set:
          id: time_of_use_4_out_power
          value: !lambda "return x;"
      - number.set:
          id: time_of_use_5_out_power
          value: !lambda "return x;"
      - number.set:
          id: time_of_use_6_out_power
          value: !lambda "return x;"

  - platform: template
    name: "Time of Use All Voltage"
    id: time_of_use_all_voltage
    unit_of_measurement: "V"
    device_class: voltage
    min_value: 0
    max_value: 63
    step: 0.01
    update_interval: 1s
    icon: "mdi:sun-clock"
    disabled_by_default: true
    lambda: |-
      return id(time_of_use_1_voltage).state;
    set_action:
      - number.set:
          id: time_of_use_1_voltage
          value: !lambda "return x;"
      - number.set:
          id: time_of_use_2_voltage
          value: !lambda "return x;"
      - number.set:
          id: time_of_use_3_voltage
          value: !lambda "return x;"
      - number.set:
          id: time_of_use_4_voltage
          value: !lambda "return x;"
      - number.set:
          id: time_of_use_5_voltage
          value: !lambda "return x;"
      - number.set:
          id: time_of_use_6_voltage
          value: !lambda "return x;"

  - platform: modbus_controller
    use_write_multiple: true
    modbus_controller_id: ${modbus_controller_id}
    name: "Time of Use 1 Raw"
    id: time_of_use_1_raw
    register_type: holding
    address: 172
    internal: true

  - platform: modbus_controller
    use_write_multiple: true
    modbus_controller_id: ${modbus_controller_id}
    name: "Time of Use 2 Raw"
    id: time_of_use_2_raw
    register_type: holding
    address: 173
    internal: true

  - platform: modbus_controller
    use_write_multiple: true
    modbus_controller_id: ${modbus_controller_id}
    name: "Time of Use 3 Raw"
    id: time_of_use_3_raw
    register_type: holding
    address: 174
    internal: true

  - platform: modbus_controller
    use_write_multiple: true
    modbus_controller_id: ${modbus_controller_id}
    name: "Time of Use 4 Raw"
    id: time_of_use_4_raw
    register_type: holding
    address: 175
    internal: true

  - platform: modbus_controller
    use_write_multiple: true
    modbus_controller_id: ${modbus_controller_id}
    name: "Time of Use 5 Raw"
    id: time_of_use_5_raw
    register_type: holding
    address: 176
    internal: true

  - platform: modbus_controller
    use_write_multiple: true
    modbus_controller_id: ${modbus_controller_id}
    name: "Time of Use 6 Raw"
    id: time_of_use_6_raw
    register_type: holding
    address: 177
    internal: true
